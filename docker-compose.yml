services:
  # ── ONETIME Setup Wizard ──
  # NOTE: The setup UI is launched by install.sh via "docker run" instead
  # of docker compose, so it has its own lifecycle. This service definition
  # is kept only as a reference / fallback but is NOT used in normal flow.
  # onetime_setup:
  #   build:
  #     context: ./ONETIME
  #     dockerfile: server/Dockerfile
  #   container_name: hcos_setup_ui
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - /opt/hcos_stack:/project
  #   environment:
  #     - PROJECT_DIR=/project
  #   profiles:
  #     - setup

  postgres:
    image: postgres:14-alpine
    container_name: postgres
    environment:
      # These variables create the DEFAULT database (used by Django)
      POSTGRES_DB: ${BACKEND_DB:-hcos_db}
      POSTGRES_USER: ${BACKEND_USER:-hcos_db_admin}
      POSTGRES_PASSWORD: ${BACKEND_PASSWORD:-hcos_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # SCRIPT TO CREATE KEYCLOAK DB ON STARTUP
      - ./init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh:ro
    networks:
      - keycloak_internal
    extra_hosts:
      - "postgres.local:host-gateway"  
    ports:
      - "5432:5432"

  postgres_chat:
    image: postgres:14-alpine
    container_name: postgres_chat
    environment:
      POSTGRES_DB: ${CHAT_DB:-staff_chat_hub}
      POSTGRES_USER: ${CHAT_DB_USER:-chat_admin}
      POSTGRES_PASSWORD: ${CHAT_DB_PASSWORD:-chat_password}
    volumes:
      - postgres_chat_data:/var/lib/postgresql/data
    networks:
      - keycloak_internal
    ports:
      - "5433:5432"     

  redis:
    image: redis:alpine
    networks:
      - keycloak_internal

  mail:
    image: bytemark/smtp:latest
    container_name: mail
    restart: always
    networks:
      - keycloak_internal

  keycloak:
    build:
      context: ./keycloak
    container_name: keycloak
    command: start --optimized
    environment:
      - KC_PROXY_HEADERS=xforwarded
      - KC_HOSTNAME=https://key.hcos.io
      - KC_HOSTNAME_STRICT=true
      - KC_HOSTNAME_BACKCHANNEL_DYNAMIC=true
      - KC_HTTP_ENABLED=true
      - KC_HTTP_PORT=3001
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://postgres:5432/keycloakdb
      - KC_DB_USERNAME=${BACKEND_USER:-hcos_db_admin}
      - KC_DB_PASSWORD=${BACKEND_PASSWORD:-hcos_password_local}
    ports:
      - "3001:3001"
    networks:
      - keycloak_internal  # Changed to use the same network as Nginx
    depends_on:
      - postgres
    extra_hosts:
      - "key.hcos.io:host-gateway"  
      - "postgres.local:host-gateway"    


  backend:
    build:
      context: ./BACKEND-API-HCOM
    container_name: backend_service
    command: daphne -v 2 -e ssl:port=5000:privateKey=/etc/letsencrypt/privkey.pem:certKey=/etc/letsencrypt/fullchain.pem hcos.asgi:application
    volumes:
      - ./BACKEND-API-HCOM:/app
      - ./certbot/conf:/etc/letsencrypt:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DATABASE_URL=postgres://${BACKEND_USER:-hcos_db_admin}:${BACKEND_PASSWORD:-hcos_password}@postgres:5432/${BACKEND_DB:-hcos_db}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - CHANNELS_REDIS_HOST=redis
      - CHANNELS_REDIS_PORT=6379
    depends_on:
      - postgres
      - redis
    networks:
      - keycloak_internal
    extra_hosts:
      - "key.hcos.io:host-gateway"       
      - "internal.local:host-gateway"
      - "postgres.local:host-gateway"
    ports:
      - "5000:5000"

  celery:
    build:
      context: ./BACKEND-API-HCOM
    container_name: celery_worker
    command: celery -A hcos worker -l info -E
    volumes:
      - ./BACKEND-API-HCOM:/app
    environment:
      - DATABASE_URL=postgres://${BACKEND_USER:-hcos_db_admin}:${BACKEND_PASSWORD:-hcos_password}@postgres:5432/${BACKEND_DB:-hcos_db}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - postgres
      - redis
      - backend
    extra_hosts:
      - "internal.local:host-gateway"
      - "postgres.local:host-gateway"  
    networks:
      - keycloak_internal

  celery-beat:
    build:
      context: ./BACKEND-API-HCOM
    container_name: celery_beat
    command: celery -A hcos beat -l info
    volumes:
      - ./BACKEND-API-HCOM:/app
    environment:
      - DATABASE_URL=postgres://${BACKEND_USER:-hcos_user_local}:${BACKEND_PASSWORD:-hcos_password_local}@postgres:5432/${BACKEND_DB:-hcos_db_local}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - postgres
      - redis
      - backend
    networks:
      - keycloak_internal

  nginx_main:
    image: nginx:latest
    container_name: nginx_main
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/templates:/etc/nginx/templates
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./ONEDASH.HCOS.IO/dist:/var/www/onedash
      - ./nginx/docker-entrypoint.sh:/docker-entrypoint.sh      
    environment:
      IS_DEBUG: ${IS_DEBUG:-true}      
    depends_on:
      - backend
      - keycloak
    networks:
      - keycloak_internal
    extra_hosts:
      - "internal.local:host-gateway"       

  frontend:
    build:
      context: ./ONEDASH.HCOS.IO
    container_name: frontend_service
    # delete node_modules to ensure a clean build
   
    volumes:
      - ./ONEDASH.HCOS.IO:/app
      - ./ONEDASH.HCOS.IO/node_modules:/app/node_modules
    networks:
      - keycloak_internal    
    extra_hosts:
      - "internal.local:host-gateway"
    command:
      - sh -c "npm install && npm run dev -- --host internal.local --port 5173"

  chat:
    build:
      context: ./REACT-CHAT
    container_name: chat_service
    # Removed volume mounts to avoid cross-platform node_modules conflicts
    # For development with hot-reload, run locally: cd REACT-CHAT && npm run dev
    environment:
      - DATABASE_URL=postgresql://${CHAT_DB_USER:-chat_admin}:${CHAT_DB_PASSWORD:-chat_password}@postgres_chat:5432/${CHAT_DB:-staff_chat_hub}
      - SESSION_SECRET=${CHAT_SESSION_SECRET:-your-secret-key-here-change-in-production}
      - KEYCLOAK_URL=https://key.hcos.io
      - KEYCLOAK_REALM=hcos
      - KEYCLOAK_CLIENT_ID=react-chat
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET:-your-client-secret}
      - KEYCLOAK_CALLBACK_URL=https://chat.hcos.io/api/callback
      - KEYCLOAK_ALLOW_HTTP=false
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - NODE_ENV=development
    depends_on:
      - postgres_chat
      - keycloak
    volumes:
      - ./REACT-CHAT:/app
      - /app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 8000"
    networks:
      - keycloak_internal
    extra_hosts:
      - "key.hcos.io:host-gateway"
      - "chat.hcos.io:host-gateway"

    ports:
      - "8000:8000"  


networks:
  local:
    driver: bridge
  keycloak_internal:
    driver: bridge
      

volumes:
  postgres_data:
    driver: local
  postgres_chat_data:
    driver: local
    
